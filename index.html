<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T&T Serenity Care: Referral Source Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Serene Sky -->
    <!-- Application Structure Plan: A two-tab single-page application. The primary tab is a "Referral Directory" featuring a dashboard with interactive charts, filterable search controls, and a grid of result cards. A secondary "Log & Notes History" tab provides a unified view of all user-entered data. This structure was chosen to separate the core task of finding referrals from the secondary task of reviewing outreach history, creating a clean, task-oriented user flow. Interactions are centered around filtering the main directory, which dynamically updates both the results grid and the dashboard charts in real-time. -->
    <!-- Visualization & Content Choices: Organization counts are visualized with a Donut chart (Goal: Proportions, Viz: Chart.js Donut, Interaction: Updates on filter) for easy comparison of categories. Specialization counts use a Bar chart (Goal: Compare, Viz: Chart.js Bar, Interaction: Updates on filter) to handle numerous categories clearly. The directory itself is a card-based grid (Goal: Organize/Inform, Viz: HTML/CSS Grid, Interaction: Filtering/Sorting) for scannability. A modal is used for data entry (Goal: Inform/Organize, Viz: HTML Form, Interaction: Opens on click) to keep the main interface clean. History is a simple list (Goal: Inform, Viz: HTML list, Interaction: N/A) for straightforward review. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a8c1d8 0%, #d8b4c8 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.4);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 50;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .nav-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #334155; /* slate-700 */
        }

        @media (min-width: 640px) {
            .nav-tab {
                padding: 0.75rem 1.5rem;
            }
        }

        .nav-tab.active {
            background-color: rgba(255, 255, 255, 0.6);
            color: #0f172a; /* slate-900 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: auto;
            height: 280px;
        }
        @media (min-width: 640px) {
            .chart-container {
                height: 320px;
            }
        }
        
        .specialization-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
        }

    </style>
</head>
<body class="text-slate-800 antialiased">
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">T&T Serenity Care</h1>
            <p class="text-lg sm:text-xl text-slate-700 mt-2">Referral Source Navigator</p>
            <div class="mt-4 max-w-4xl mx-auto text-slate-600">
                <p>This interactive tool provides a curated list of potential referral sources within a 50-mile radius of Apopka, FL. Use the filters below to explore organizations, medical facilities, and support groups that serve individuals with developmental, medical, and physical needs aligned with T&T Serenity Care's services.</p>
            </div>
        </header>

        <nav class="flex justify-center mb-8 sm:mb-12">
            <div class="glass-panel p-1.5 sm:p-2 rounded-xl shadow-md flex space-x-1 sm:space-x-2">
                <div id="tab-directory" class="nav-tab active">Directory</div>
                <div id="tab-history" class="nav-tab">History</div>
            </div>
        </nav>

        <main>
            <!-- View 1: Referral Directory -->
            <div id="view-directory" class="view active">
                <!-- Filter Controls -->
                <section id="filters" class="glass-panel p-4 sm:p-6 rounded-3xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800">Filter and Search</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Search -->
                        <div class="md:col-span-1">
                            <label for="search-input" class="block text-sm font-medium text-slate-700 mb-1">Search by Name</label>
                            <input type="text" id="search-input" placeholder="Enter organization name..." class="w-full p-3 rounded-xl border border-white/30 bg-white/50 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                        </div>
                        <!-- Category Filter -->
                        <div class="md:col-span-1">
                            <label for="category-filter" class="block text-sm font-medium text-slate-700 mb-1">Filter by Category</label>
                            <select id="category-filter" class="w-full p-3 rounded-xl border border-white/30 bg-white/50 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                                <option value="all">All Categories</option>
                                <option value="Condition-Specific Non-Profit / Support Group">Non-Profits & Support Groups</option>
                                <option value="Medical / Healthcare">Medical & Healthcare</option>
                                <option value="Community / Government">Community & Government</option>
                            </select>
                        </div>
                         <!-- Specialization Filter -->
                        <div class="md:col-span-3">
                             <label class="block text-sm font-medium text-slate-700 mb-2">Filter by Specialization</label>
                            <div id="specialization-filters" class="grid grid-cols-2 sm:grid-cols-3 md:flex md:flex-wrap gap-x-4 gap-y-3 sm:gap-x-6">
                            </div>
                        </div>
                    </div>
                </section>
                
                 <!-- Data Management -->
                <section id="data-management" class="glass-panel p-4 sm:p-6 rounded-3xl shadow-lg mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="text-slate-800 text-center md:text-left">
                            <h2 class="text-xl font-semibold">Data Management & Sharing</h2>
                            <p class="text-sm text-slate-600 mt-1 max-w-xl">Use **Share via Email** for team updates. The **Import/Export** buttons are for manual backups or transfers.</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto mt-4 md:mt-0">
                            <button id="import-btn" class="bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition duration-300 w-full sm:w-auto">Import</button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                            <button id="export-btn" class="bg-gray-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-gray-700 transition duration-300 w-full sm:w-auto">Export</button>
                            <button id="share-btn" class="bg-green-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-600 transition duration-300 w-full sm:w-auto">Share via Email</button>
                        </div>
                    </div>
                </section>

                <!-- Dashboard -->
                <section id="dashboard" class="mb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-panel p-4 sm:p-6 rounded-3xl shadow-lg">
                            <h3 class="text-lg font-semibold text-center mb-4 text-slate-800">Sources by Category</h3>
                             <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel p-4 sm:p-6 rounded-3xl shadow-lg">
                            <h3 class="text-lg font-semibold text-center mb-4 text-slate-800">Sources by Specialization</h3>
                             <div class="chart-container">
                                <canvas id="specializationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Results -->
                <section id="results">
                    <div id="loading-state" class="text-center py-10">
                        <p class="text-slate-700">Loading referral directory...</p>
                    </div>
                    <div id="results-content" class="hidden">
                         <div id="offline-notice-container"></div>
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 px-2 gap-2">
                            <h2 class="text-2xl font-semibold text-slate-900">Referral Sources</h2>
                            <div class="text-left sm:text-right">
                                <span id="results-count" class="font-bold text-slate-800 text-lg"></span>
                                <span class="text-slate-600">organizations found</span>
                            </div>
                        </div>
                        <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                    </div>
                </section>
            </div>

            <!-- View 2: Log & Notes History -->
            <div id="view-history" class="view">
                <section id="history-log" class="glass-panel p-4 sm:p-6 rounded-3xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-slate-900 mb-4">Combined Log & Notes History</h2>
                    <div id="history-content" class="space-y-6 max-h-[80vh] overflow-y-auto pr-2 sm:pr-4">
                        <!-- History items will be injected here -->
                    </div>
                </section>
            </div>
        </main>

        <footer class="text-center mt-12 py-4">
            <p class="text-white/70">&copy; 2025 T&T Serenity Care | Data compiled for internal use.</p>
        </footer>
    </div>

    <!-- Notes Modal -->
    <div id="notes-modal" class="modal-overlay p-4">
        <div class="modal-content glass-panel p-5 sm:p-8 rounded-3xl shadow-2xl w-full max-w-sm sm:max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl sm:text-2xl font-bold text-slate-900">Log & Notes</h2>
                <button id="modal-close-btn" class="text-slate-600 hover:text-slate-900 transition text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2">
                <!-- Notes -->
                <div>
                    <label for="modal-notes" class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                    <textarea id="modal-notes" rows="6" class="w-full p-3 rounded-xl border border-white/30 bg-white/50 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" placeholder="Add general notes here..."></textarea>
                </div>

                <!-- Contact Log -->
                <div class="mt-6">
                    <h3 class="font-semibold text-slate-800 mb-2">Contact Log</h3>
                    <div id="modal-contact-list" class="space-y-2 mb-4">
                        <!-- Contact items will be injected here -->
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 items-center">
                        <input type="text" id="modal-contact-by" placeholder="Your Name" class="w-full sm:flex-grow p-3 rounded-xl border border-white/30 bg-white/50 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                        <button id="modal-add-contact-btn" class="bg-blue-500 text-white font-semibold py-3 px-5 rounded-lg hover:bg-blue-600 transition w-full sm:w-auto">Log Contact</button>
                    </div>
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="mt-6 pt-4 border-t border-white/30">
                <button id="modal-save-btn" class="bg-green-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-600 transition w-full">Save and Close</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const DATA_URL = 'https://codeamani-solutions.github.io/Serenity-care-marketing-dashboard/referral_sources.json';
            const CACHE_KEY = 'referralDataCache';
            const TIMESTAMP_KEY = 'referralDataTimestamp';
            const CACHE_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours

            // --- NEW: Fallback data is embedded here ---
            const fallbackData = [
              { "id": "cfl-autism-center", "name": "UCF Center for Autism & Related Disabilities (CARD)", "address": "4000 Central Florida Blvd, Orlando, FL 32816", "contact": { "phone": "407-823-6001", "email": "ucfcard@ucf.edu", "website": "https://ucf-card.org/" }, "contactPerson": "Program Director", "relevance": "Provides resources and support for individuals with Autism Spectrum Disorders from birth through adulthood.", "category": "Condition-Specific Non-Profit / Support Group", "specializations": [ "Autism Spectrum Disorders", "Developmental & Intellectual" ] },
              { "id": "down-syndrome-assoc-cf", "name": "Down Syndrome Association of Central Florida", "address": "204 N Westmonte Dr, Altamonte Springs, FL 32714", "contact": { "phone": "407-478-5621", "email": "info@dsacf.org", "website": "https://www.dsacf.org/" }, "contactPerson": "Executive Director", "relevance": "Offers support, resources, and programs for individuals with Down Syndrome and their families.", "category": "Condition-Specific Non-Profit / Support Group", "specializations": [ "Intellectual Disabilities", "Developmental & Intellectual" ] },
              { "id": "cerebral-palsy-cf", "name": "United Cerebral Palsy of Central Florida", "address": "332 N Laurel Ave, Orlando, FL 32801", "contact": { "phone": "407-852-3300", "email": "N/A", "website": "https://www.ucpcfl.org/" }, "contactPerson": "Family Services Coordinator", "relevance": "Provides comprehensive services including therapy, education, and support for individuals with Cerebral Palsy and other disabilities.", "category": "Condition-Specific Non-Profit / Support Group", "specializations": [ "Cerebral Palsy", "Developmental & Intellectual", "Physical & Medical" ] },
              { "id": "nemours-childrens", "name": "Nemours Children's Hospital, Florida", "address": "6535 Nemours Pkwy, Orlando, FL 32827", "contact": { "phone": "407-567-4000", "email": "N/A", "website": "https://www.nemours.org/locations/nemours-childrens-hospital-florida" }, "contactPerson": "Neurology Department / Social Work Dept.", "relevance": "Specialized pediatric hospital with departments for neurology, developmental medicine, and complex medical needs.", "category": "Medical / Healthcare", "specializations": [ "Epilepsy", "Chronic Medical Conditions", "Cerebral Palsy", "Spina Bifida", "Hearing and Visual Impairaments" ] },
              { "id": "adventhealth-rehab", "name": "AdventHealth Rehabilitation Center", "address": "601 E Rollins St, Orlando, FL 32803", "contact": { "phone": "407-303-6611", "email": "N/A", "website": "https://www.adventhealth.com/hospital/adventhealth-orlando/rehabilitation-and-physical-therapy" }, "contactPerson": "Patient Navigator / Rehab Services", "relevance": "Offers inpatient and outpatient physical, occupational, and speech therapy for adults and children with mobility impairments and neurological conditions.", "category": "Medical / Healthcare", "specializations": [ "Mobility Impairments", "Physical & Medical" ] },
              { "id": "orlando-health-arnold-palmer", "name": "Orlando Health Arnold Palmer Hospital for Children", "address": "92 W Miller St, Orlando, FL 32806", "contact": { "phone": "321-841-5111", "email": "N/A", "website": "https://www.arnoldpalmerhospital.com/" }, "contactPerson": "Developmental Center for Infants & Children", "relevance": "Top-tier children's hospital with comprehensive services for complex medical needs, developmental delays, and chronic conditions.", "category": "Medical / Healthcare", "specializations": [ "Chronic Medical Conditions", "Developmental & Intellectual", "Physical & Medical" ] },
              { "id": "apd-central-region", "name": "Agency for Persons with Disabilities (APD) - Central Region", "address": "400 W Robinson St, Orlando, FL 32801", "contact": { "phone": "407-245-0440", "email": "N/A", "website": "https://apd.myflorida.com/region/central/" }, "contactPerson": "Waiver Support Coordinator Supervisor", "relevance": "State agency responsible for coordinating services for Floridians with developmental disabilities, including waiver programs.", "category": "Community / Government", "specializations": [ "Intellectual Disabilities", "Autism Spectrum Disorders", "Cerebral Palsy", "Spina Bifida", "Prader-Willi Syndrome", "Dual Diagnosis" ] },
              { "id": "center-independent-living-cf", "name": "Center for Independent Living in Central Florida", "address": "720 N Denning Dr, Winter Park, FL 32789", "contact": { "phone": "407-623-1070", "email": "info@cilorlando.org", "website": "https://cilorlando.org/" }, "contactPerson": "Information and Referral Specialist", "relevance": "Provides advocacy, resources, and skills training for people with all types of disabilities to live more independently.", "category": "Community / Government", "specializations": [ "Mobility Impairments", "Hearing and Visual Impairaments", "Developmental & Intellectual", "Physical & Medical" ] },
              { "id": "best-buddies-cf", "name": "Best Buddies in Central Florida", "address": "111 N Orange Ave #770, Orlando, FL 32801", "contact": { "phone": "407-898-0028", "email": "centralflorida@bestbuddies.org", "website": "https://www.bestbuddies.org/florida/central-florida" }, "contactPerson": "Program Manager", "relevance": "Creates opportunities for one-to-one friendships, integrated employment, and leadership development for people with intellectual and developmental disabilities (IDD).", "category": "Community / Government", "specializations": [ "Developmental & Intellectual", "Physical & Medical" ] },
              { "id": "the-arc-sunrise", "name": "The Arc Sunrise of Central Florida", "address": "100 S. Main Street, Leesburg, FL 34748", "contact": { "phone": "352-326-2211", "email": "N/A", "website": "https://www.arcsunrise.org/" }, "contactPerson": "Director of Services", "relevance": "Provides residential, employment, and life skills training for adults with intellectual and developmental disabilities in Lake County.", "category": "Community / Government", "specializations": [ "Intellectual Disabilities", "Developmental & Intellectual", "Dual Diagnosis" ] },
              { "id": "early-learning-lake", "name": "Early Learning Coalition of Lake County", "address": "1300 Citizens Blvd, Leesburg, FL 34748", "contact": { "phone": "352-435-0566", "email": "N/A", "website": "https://www.elclc.org/" }, "contactPerson": "Inclusion Specialist", "relevance": "Offers resources and support for early childhood development, including programs for children with special needs and developmental delays.", "category": "Community / Government", "specializations": [ "Developmental & Intellectual" ] },
              { "id": "lakeland-regional-neuro", "name": "Lakeland Regional Health - Neurology", "address": "1324 Lakeland Hills Blvd, Lakeland, FL 33805", "contact": { "phone": "863-284-5000", "email": "N/A", "website": "https://www.mylrh.org/neurosciences/" }, "contactPerson": "Patient Care Coordinator", "relevance": "Major regional hospital with a dedicated neuroscience and neurology department treating conditions like Epilepsy and Cerebral Palsy.", "category": "Medical / Healthcare", "specializations": [ "Epilepsy", "Cerebral Palsy", "Physical & Medical" ] },
              { "id": "center-for-autism-polk", "name": "The Center for Autism and Related Disabilities (CARD) at USF - Polk County", "address": "Florida Polytechnic University, 4700 Research Way, Lakeland, FL 33805", "contact": { "phone": "813-974-2532", "email": "card-usf@usf.edu", "website": "https://card-usf.fmhi.usf.edu/" }, "contactPerson": "Polk County Outreach Coordinator", "relevance": "Satellite office of USF CARD, providing direct assistance and resources to individuals and families affected by autism in Polk County.", "category": "Condition-Specific Non-Profit / Support Group", "specializations": [ "Autism Spectrum Disorders", "Developmental & Intellectual" ] },
              { "id": "new-vision-for-independence", "name": "New Vision for Independence", "address": "224 N. Main Ave, Groveland, FL 34736", "contact": { "phone": "352-435-5040", "email": "info@newvisionfl.org", "website": "https://newvisionfl.org/" }, "contactPerson": "Client Services Manager", "relevance": "Provides training and support for individuals with low vision or blindness in Lake and Sumter counties, promoting independence.", "category": "Condition-Specific Non-Profit / Support Group", "specializations": [ "Hearing and Visual Impairaments", "Physical & Medical" ] }
            ];

            let referralSources = [];
            let allSpecializations = [];

            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const specializationFiltersContainer = document.getElementById('specialization-filters');
            const resultsGrid = document.getElementById('results-grid');
            const resultsCount = document.getElementById('results-count');
            const loadingState = document.getElementById('loading-state');
            const resultsContent = document.getElementById('results-content');
            const offlineNoticeContainer = document.getElementById('offline-notice-container');
            
            const tabDirectory = document.getElementById('tab-directory');
            const tabHistory = document.getElementById('tab-history');
            const viewDirectory = document.getElementById('view-directory');
            const viewHistory = document.getElementById('view-history');
            const historyContent = document.getElementById('history-content');

            const notesModal = document.getElementById('notes-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalNotes = document.getElementById('modal-notes');
            const modalContactList = document.getElementById('modal-contact-list');
            const modalContactBy = document.getElementById('modal-contact-by');
            const modalAddContactBtn = document.getElementById('modal-add-contact-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const shareBtn = document.getElementById('share-btn');

            let categoryChart, specializationChart;
            let userData = {};
            let currentEditingId = null;

            const state = {
                searchTerm: '',
                category: 'all',
                specializations: []
            };

            function initializeUI(data, isOffline = false) {
                referralSources = data;
                allSpecializations = [...new Set(referralSources.flatMap(s => s.specializations))].sort();
                
                loadUserData(); 
                initSpecializationFilters();
                setupCharts();
                render();
                
                loadingState.classList.add('hidden');
                resultsContent.classList.remove('hidden');

                if (isOffline) {
                    offlineNoticeContainer.innerHTML = `<p id="cache-notice" class="text-center text-sm text-slate-600 mb-4 bg-yellow-100/50 p-2 rounded-lg">Could not connect to server. Displaying cached or backup data.</p>`;
                }
            }
            
            async function fetchAndUpdateCache() {
                try {
                    const response = await fetch(DATA_URL);
                    if (!response.ok) return;
                    const data = await response.json();
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(TIMESTAMP_KEY, Date.now().toString());
                    console.log("Background cache updated.");
                } catch (error) {
                    console.error("Failed to update cache in background:", error);
                }
            }

            async function initializeApp() {
                const cachedData = localStorage.getItem(CACHE_KEY);
                const cachedTimestamp = localStorage.getItem(TIMESTAMP_KEY);

                if (cachedData && cachedTimestamp) {
                    const age = Date.now() - parseInt(cachedTimestamp, 10);
                    if (age < CACHE_DURATION_MS) {
                        console.log("Loading fresh data from cache.");
                        initializeUI(JSON.parse(cachedData));
                        fetchAndUpdateCache(); // Update in background
                        return;
                    }
                }

                try {
                    const response = await fetch(DATA_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(TIMESTAMP_KEY, Date.now().toString());
                    console.log("Fetched new data and cached it.");
                    initializeUI(data);
                } catch (error) {
                    console.error("Failed to fetch from network:", error);
                    // --- MODIFIED: Fallback logic ---
                    if (cachedData) {
                        console.log("Network failed. Falling back to stale cache.");
                        initializeUI(JSON.parse(cachedData), true);
                    } else if (fallbackData && fallbackData.length > 0) {
                        console.log("Network failed and no cache. Using built-in fallback data.");
                        initializeUI(fallbackData, true);
                    } else {
                        loadingState.innerHTML = `<p class="text-red-500 font-semibold">Error: Could not load the referral directory.<br>Please check your internet connection and try again.</p>`;
                    }
                }
            }


            function initSpecializationFilters() {
                specializationFiltersContainer.innerHTML = allSpecializations.map(spec => `
                    <label for="spec-${spec.replace(/[\s&]+/g, '-')}" class="flex items-center space-x-2 cursor-pointer group">
                        <input type="checkbox" id="spec-${spec.replace(/[\s&]+/g, '-')}" class="specialization-checkbox h-5 w-5 rounded-md border-white/40 text-blue-500 focus:ring-blue-400 focus:ring-offset-0 bg-white/50 group-hover:bg-white/70 transition" value="${spec}">
                        <span class="text-slate-700 text-sm sm:text-base">${spec}</span>
                    </label>
                `).join('');
            }

            function createCard(source) {
                const sourceData = userData[source.id] || { notes: [], contacts: [] };
                const hasData = (sourceData.notes && sourceData.notes.length > 0) || (sourceData.contacts && sourceData.contacts.length > 0);
                
                return `
                    <div class="glass-panel p-5 sm:p-6 rounded-3xl shadow-lg flex flex-col justify-between transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-slate-900 pr-2">${source.name}</h3>
                                ${hasData ? '<span class="mt-1 flex-shrink-0 h-3 w-3 rounded-full bg-green-400" title="Notes or logs exist"></span>' : ''}
                            </div>
                            <p class="text-sm text-slate-600 font-medium mt-1 mb-3">${source.category}</p>
                            <p class="text-slate-700 mb-2"><span class="font-semibold">Address:</span> ${source.address}</p>
                             <div class="mb-3 text-slate-700 space-y-1">
                                ${source.contact.phone !== 'N/A' ? `<p><span class="font-semibold">Phone:</span> <a href="tel:${source.contact.phone}" class="text-blue-700 hover:underline font-medium">${source.contact.phone}</a></p>` : ''}
                                ${source.contact.email !== 'N/A' ? `<p><span class="font-semibold">Email:</span> <a href="mailto:${source.contact.email}" class="text-blue-700 hover:underline font-medium">${source.contact.email}</a></p>` : ''}
                                ${source.contact.website ? `<p><span class="font-semibold">Website:</span> <a href="${source.contact.website}" target="_blank" class="text-blue-700 hover:underline font-medium">Visit Website</a></p>` : ''}
                            </div>
                            <p class="text-slate-700 mb-4"><span class="font-semibold">Key Contact:</span> ${source.contactPerson}</p>
                            <p class="text-sm bg-white/30 p-3 rounded-xl border border-white/20"><span class="font-semibold text-blue-900">Relevance:</span> ${source.relevance}</p>
                        </div>
                         <div class="mt-4 pt-4 border-t border-white/20">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                                <div>
                                    <p class="text-xs font-semibold text-slate-500 uppercase mb-2">Specializations</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${source.specializations.map(spec => `<span class="bg-white/40 text-slate-800 text-xs font-medium px-2.5 py-1 rounded-full">${spec}</span>`).join('')}
                                    </div>
                                </div>
                                <button class="open-notes-btn bg-slate-500/50 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500/70 transition text-sm w-full sm:w-auto flex-shrink-0" data-id="${source.id}" data-name="${source.name}">Log & Notes</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function loadUserData() {
                const savedData = localStorage.getItem('ttSerenityCareUserData');
                if (savedData) {
                    userData = JSON.parse(savedData);
                }
            }

            function saveUserData() {
                localStorage.setItem('ttSerenityCareUserData', JSON.stringify(userData));
            }

            function render() {
                if (!referralSources.length) return;
                const filteredSources = referralSources.filter(source => {
                    const searchMatch = source.name.toLowerCase().includes(state.searchTerm.toLowerCase());
                    const categoryMatch = state.category === 'all' || source.category === state.category;
                    const specializationMatch = state.specializations.length === 0 || state.specializations.every(spec => source.specializations.includes(spec));
                    return searchMatch && categoryMatch && specializationMatch;
                });

                resultsGrid.innerHTML = filteredSources.map(createCard).join('');
                resultsCount.textContent = filteredSources.length;
                updateCharts(filteredSources);
            }

            function renderHistory() {
                const historyItems = [];
                for (const id in userData) {
                    const sourceInfo = referralSources.find(s => s.id === id);
                    if (!sourceInfo) continue;

                    const data = userData[id];
                    if ((data.notes && data.notes.length > 0) || (data.contacts && data.contacts.length > 0)) {
                        historyItems.push({
                            name: sourceInfo.name,
                            notes: data.notes || [],
                            contacts: data.contacts || []
                        });
                    }
                }

                if (historyItems.length === 0) {
                    historyContent.innerHTML = `<p class="text-slate-600 text-center">No notes or contact logs have been saved yet.</p>`;
                    return;
                }
                
                historyContent.innerHTML = historyItems.sort((a,b) => a.name.localeCompare(b.name)).map(item => `
                    <div class="bg-white/20 p-4 rounded-xl border border-white/20">
                        <h3 class="text-xl font-bold text-slate-800">${item.name}</h3>
                        ${item.notes.length > 0 ? `
                            <div class="mt-3">
                                <h4 class="font-semibold text-slate-700">Notes:</h4>
                                <div class="space-y-2 mt-1">
                                ${[...item.notes].reverse().map(note => `
                                    <div class="p-2 bg-white/20 rounded-md">
                                        <p class="text-slate-600 whitespace-pre-wrap">${note.text}</p>
                                        <p class="text-xs text-slate-500 text-right mt-1">by <strong>${note.by}</strong> on ${note.date}</p>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${item.contacts.length > 0 ? `
                            <div class="mt-3">
                                <h4 class="font-semibold text-slate-700">Contact History:</h4>
                                <div class="space-y-1 mt-1">
                                ${[...item.contacts].reverse().map(c => `
                                    <div class="text-sm flex flex-col sm:flex-row justify-between sm:items-center bg-white/20 p-2 rounded-md gap-1">
                                        <span>Contacted by <strong>${c.by}</strong></span>
                                        <span class="text-slate-500 text-xs sm:text-sm">${c.date}</span>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            function switchView(viewName) {
                if (viewName === 'directory') {
                    viewDirectory.classList.add('active');
                    viewHistory.classList.remove('active');
                    tabDirectory.classList.add('active');
                    tabHistory.classList.remove('active');
                } else {
                    viewDirectory.classList.remove('active');
                    viewHistory.classList.add('active');
                    tabDirectory.classList.remove('active');
                    tabHistory.classList.add('active');
                    renderHistory();
                }
            }

            function openModal(id, name) {
                currentEditingId = id;
                if (!userData[id]) {
                    userData[id] = { notes: [], contacts: [] };
                }
                modalTitle.textContent = name;
                modalNotes.value = ''; // Clear textarea for new note
                renderContactList();
                notesModal.classList.add('active');
            }

            function closeModal() {
                notesModal.classList.remove('active');
                currentEditingId = null;
            }
            
            function renderContactList() {
                if (!currentEditingId || !userData[currentEditingId].contacts) {
                    modalContactList.innerHTML = '<p class="text-sm text-slate-500">No contacts logged yet.</p>';
                    return;
                }
                 const contacts = userData[currentEditingId].contacts;
                if (contacts.length === 0) {
                     modalContactList.innerHTML = '<p class="text-sm text-slate-500">No contacts logged yet.</p>';
                    return;
                }
                modalContactList.innerHTML = [...contacts].reverse().map(c => `
                    <div class="text-sm flex justify-between items-center bg-white/20 p-2 rounded-md">
                        <span>Contacted by <strong>${c.by}</strong></span>
                        <span class="text-slate-500">${c.date}</span>
                    </div>
                `).join('');
            }

            function updateCharts(filteredData) {
                const categoryCounts = filteredData.reduce((acc, source) => {
                    const categoryName = source.category === "Condition-Specific Non-Profit / Support Group" ? "Non-Profit" :
                                         source.category === "Medical / Healthcare" ? "Medical" : "Government";
                    acc[categoryName] = (acc[categoryName] || 0) + 1;
                    return acc;
                }, {});

                const specializationCounts = filteredData.flatMap(s => s.specializations).reduce((acc, spec) => {
                    acc[spec] = (acc[spec] || 0) + 1;
                    return acc;
                }, {});

                categoryChart.data.labels = Object.keys(categoryCounts);
                categoryChart.data.datasets[0].data = Object.values(categoryCounts);
                categoryChart.update();

                const sortedSpecs = Object.entries(specializationCounts).sort(([,a],[,b]) => b-a);

                specializationChart.data.labels = sortedSpecs.map(s => s[0]);
                specializationChart.data.datasets[0].data = sortedSpecs.map(s => s[1]);
                specializationChart.update();
            }

            function setupCharts() {
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                const specializationCtx = document.getElementById('specializationChart').getContext('2d');
                specializationChart = new Chart(specializationCtx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: '# of Sources', data: [], backgroundColor: '#60a5fa', borderRadius: 6 }] },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { ticks: { font: { size: 10 } } } }
                    }
                });
            }

            searchInput.addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                render();
            });

            categoryFilter.addEventListener('change', (e) => {
                state.category = e.target.value;
                render();
            });

            specializationFiltersContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('specialization-checkbox')) {
                    state.specializations = [...document.querySelectorAll('.specialization-checkbox:checked')].map(cb => cb.value);
                    render();
                }
            });

            resultsGrid.addEventListener('click', (e) => {
                const button = e.target.closest('.open-notes-btn');
                if (button) {
                    const id = button.dataset.id;
                    const name = button.dataset.name;
                    openModal(id, name);
                }
            });

            modalCloseBtn.addEventListener('click', closeModal);
            notesModal.addEventListener('click', (e) => {
                if(e.target === notesModal) closeModal();
            });

            modalSaveBtn.addEventListener('click', () => {
                if (currentEditingId) {
                    const noteText = modalNotes.value.trim();
                    const author = prompt("Please enter your name to log this note:", localStorage.getItem('tntUserName') || '');

                    if (author) {
                        localStorage.setItem('tntUserName', author); // Remember the name for next time
                        if (noteText) {
                            const newNote = {
                                text: noteText,
                                by: author,
                                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                            };
                            if (!userData[currentEditingId].notes) {
                                userData[currentEditingId].notes = [];
                            }
                            userData[currentEditingId].notes.push(newNote);
                        }
                        saveUserData();
                        render();
                        closeModal();
                    } else {
                        alert("Author name is required to save a note.");
                    }
                }
            });

            modalAddContactBtn.addEventListener('click', () => {
                const contactBy = modalContactBy.value.trim();
                if (contactBy && currentEditingId) {
                    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    if (!userData[currentEditingId].contacts) {
                        userData[currentEditingId].contacts = [];
                    }
                    userData[currentEditingId].contacts.push({ by: contactBy, date: today });
                    modalContactBy.value = '';
                    renderContactList();
                    saveUserData(); 
                    render(); 
                }
            });

            function downloadUserData() {
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `T&T_Notes_${timestamp}.json`;
                document.body.appendChild(link);
                link.href = url;
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                return link.download;
            }

            exportBtn.addEventListener('click', () => {
                downloadUserData();
            });
            
            shareBtn.addEventListener('click', () => {
                const filename = downloadUserData();
                const subject = "T&T Serenity Care - Updated Log & Notes File";
                const body = `Hello team,\n\nPlease find the latest Log & Notes file attached ("${filename}").\n\nThis file should be imported into the Referral Source Navigator to get the latest updates.\n\nThank you!`;
                
                const mailtoLink = `mailto:info+lognotes@tntserenitycare.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                window.location.href = mailtoLink;
            });

            importBtn.addEventListener('click', () => importFile.click());

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation could be added here
                        userData = importedData;
                        saveUserData();
                        render();
                        if (viewHistory.classList.contains('active')) {
                            renderHistory();
                        }
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
                importFile.value = ''; // Reset for next import
            });

            tabDirectory.addEventListener('click', () => switchView('directory'));
            tabHistory.addEventListener('click', () => switchView('history'));

            initializeApp();

        });
    </script>
</body>
</html>

